# test/feature/arena_test.org

Arena : resource [
    setup: { 
        ptr : ["arena_create"] @ sys; 
        ["write" 1 "[ARENA SETUP] Created Arena: " -1] @ sys;
        ["write" 1 ptr -1] @ sys;
        ["write" 1 "\n" -1] @ sys;
        ptr
    }
    teardown: { 
        ["write" 1 "[ARENA TEARDOWN] Freeing Arena: " -1] @ sys;
        ["write" 1 left -1] @ sys;
        ["write" 1 "\n" -1] @ sys;
        ["arena_release" left] @ sys
    }
    next: { right }
];

Tracked : resource [
    setup: { 
        ["write" 1 "[TRACKED SETUP]\n" -1] @ sys;
        "TrackedState" 
    }
    teardown: {
        ["write" 1 "[TRACKED TEARDOWN]\n" -1] @ sys
    }
    next: { right }
];

["write" 1 "--- START TEST 1 (Middleware) ---\n" -1] @ sys;
# 1. Standard Middleware
# [1] -> @Tracked -> @Arena -> @stdout
# @Tracked is allocated in @Arena. 
# @Tracked iterator should teardown itself before @Arena teardown.
[1] -> Tracked -> Arena -> @stdout;

["write" 1 "\n--- START TEST 2 (Leak Cleanup) ---\n" -1] @ sys;
# 2. Leaked Resource
# We create @Tracked inside the flow but don't bind it to a Scope/Flow lifecycle.
# It strictly lives as a value in the Arena.
# When @Arena teardown happens, it must find this orphan and kill it.
[1] -> { val: @Tracked; right } -> Arena -> @stdout;
